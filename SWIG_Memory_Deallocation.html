

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Table of Contents &mdash; CookBook 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="CookBook 0.1 documentation" href="index.html" />
    <link rel="next" title="Table of Contents" href="SWIG_NumPy_examples.html" />
    <link rel="prev" title="Addressing Array Columns by Name" href="Recarray.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SWIG_NumPy_examples.html" title="Table of Contents"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Recarray.html" title="Addressing Array Columns by Name"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">CookBook 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="table-of-contents">
<h1>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">¶</a></h1>
<p>TableOfContents</p>
</div>
<div class="section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="recipe-description">
<h2>Recipe description<a class="headerlink" href="#recipe-description" title="Permalink to this headline">¶</a></h2>
<p>This cookbook recipe describes the automatic deallocation of memory
blocks allocated via `malloc()` calls in C, when the corresponding
Python numpy array objects are destroyed. The recipe uses SWIG and a
modified `numpy.i` helper file.</p>
<p>To be more specific, new fragments were added to the existing
`numpy.i` to handle automatic deallocation of arrays, the size of
which is not known in advance. As with the original fragments, a block
of `malloc()` memory can be converted into a returned numpy python
object via a call to `PyArray_SimpleNewFromData()`. However, the
returned python object is created using `PyCObject_FromVoidPtr()`,
which ensures that the allocated memory is automatically disposed of
when the Python object is destroyed. Examples below show how using these
new fragments avoids leaking memory.</p>
<p>Since the new fragments are based on the `_ARGOUTVIEW_` ones, the
name `_ARGOUTVIEWM_` was chosen, where `M` stands for managed. All
managed fragments (ARRAY1, 2 and 3, FARRAY1, 2 and 3) were implemented,
and have now been extensively tested.</p>
</div>
<div class="section" id="where-to-get-the-files">
<h2>Where to get the files<a class="headerlink" href="#where-to-get-the-files" title="Permalink to this headline">¶</a></h2>
<p>At the moment, the modified numpy.i file is available here (last updated
2012-04-22): * <a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/numpy.i">http://ezwidgets.googlecode.com/svn/trunk/numpy/numpy.i</a>
* <a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/pyfragments.swg">http://ezwidgets.googlecode.com/svn/trunk/numpy/pyfragments.swg</a></p>
</div>
<div class="section" id="how-the-code-came-about">
<h2>How the code came about<a class="headerlink" href="#how-the-code-came-about" title="Permalink to this headline">¶</a></h2>
<p>The original memory deallocation code was written by Travis Oliphant
(see <a class="reference external" href="http://blog.enthought.com/?p=62">http://blog.enthought.com/?p=62</a> ) and as far as I know, these
clever people were the first ones to use it in a swig file (see
<a class="reference external" href="http://niftilib.sourceforge.net/pynifti">http://niftilib.sourceforge.net/pynifti</a>, file nifticlib.i). Lisandro
Dalcin then pointed out a simplified implementation using
<a class="reference external" href="http://docs.python.org/c-api/cobject.html">CObjects</a>, which Travis
details in this <a class="reference external" href="http://blog.enthought.com/python/numpy/simplified-creation-of-numpy-arrays-from-pre-allocated-memory/">updated blog
post</a>.</p>
</div>
</div>
<div class="section" id="how-to-use-the-new-fragments">
<h1>How to use the new fragments<a class="headerlink" href="#how-to-use-the-new-fragments" title="Permalink to this headline">¶</a></h1>
<div class="section" id="important-steps">
<h2>Important steps<a class="headerlink" href="#important-steps" title="Permalink to this headline">¶</a></h2>
<p>In yourfile.i, the %init function uses the same `import_array()` call
you already know:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="o">%</span><span class="n">init</span> <span class="o">%</span><span class="p">{</span>
    <span class="n">import_array</span><span class="p">();</span>
<span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>... then just use ARGOUTVIEWM_ARRAY1 instead of ARGOUTVIEW_ARRAY1 and
memory deallocation is handled automatically when the python array is
destroyed (see examples below).</p>
</div>
</div>
<div class="section" id="a-simple-argoutviewm-array1-example">
<h1>A simple ARGOUTVIEWM_ARRAY1 example<a class="headerlink" href="#a-simple-argoutviewm-array1-example" title="Permalink to this headline">¶</a></h1>
<p>The SWIG-wrapped function in C creates an N integers array, using
`malloc()` to allocate memory. From python, this function is
repetitively called and the array created destroyed (M times).</p>
<p>Using the ARGOUTVIEW_ARRAY1 provided in numpy.i, this will create
memory leaks (I know ARGOUTVIEW_ARRAY1 has not been designed for this
purpose but it&#8217;s tempting!).</p>
<p>Using the ARGOUTVIEWM_ARRAY1 fragment instead, the memory allocated
with `malloc()` will be automatically deallocated when the array is
deleted.</p>
<p>The python test program creates and deletes a 1024^2 ints array 2048
times using both ARGOUTVIEW_ARRAY1 and ARGOUTVIEWM_ARRAY1 and when
memory allocation fails, an exception is generated in C and caught in
Python, showing which iteration finally caused the allocation to fail.</p>
<div class="section" id="the-c-source-ezalloc-c-and-ezalloc-h">
<h2>The C source (ezalloc.c and ezalloc.h)<a class="headerlink" href="#the-c-source-ezalloc-c-and-ezalloc-h" title="Permalink to this headline">¶</a></h2>
<p>Here is the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/ezalloc.h">ezalloc.h</a>
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">void</span> <span class="n">alloc</span><span class="p">(</span><span class="nb">int</span> <span class="n">ni</span><span class="p">,</span> <span class="nb">int</span><span class="o">**</span> <span class="n">veco</span><span class="p">,</span> <span class="nb">int</span> <span class="o">*</span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
<p>Here is the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/ezalloc.c">ezalloc.c</a>
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#include &lt;stdio.h&gt;</span>
<span class="c">#include &lt;errno.h&gt;</span>
<span class="c">#include &quot;ezalloc.h&quot;</span>

<span class="n">void</span> <span class="n">alloc</span><span class="p">(</span><span class="nb">int</span> <span class="n">ni</span><span class="p">,</span> <span class="nb">int</span><span class="o">**</span> <span class="n">veco</span><span class="p">,</span> <span class="nb">int</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nb">int</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">ni</span><span class="o">*</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>

    <span class="o">//</span><span class="n">veco</span> <span class="ow">is</span> <span class="n">either</span> <span class="n">NULL</span> <span class="ow">or</span> <span class="n">pointing</span> <span class="n">to</span> <span class="n">the</span> <span class="n">allocated</span> <span class="n">block</span> <span class="n">of</span> <span class="n">memory</span><span class="o">...</span>
    <span class="o">*</span><span class="n">veco</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
    <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">ni</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-interface-file-ezalloc-i">
<h2>The interface file (ezalloc.i)<a class="headerlink" href="#the-interface-file-ezalloc-i" title="Permalink to this headline">¶</a></h2>
<p>The file (available here:
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/ezalloc.i">ezalloc.i</a>)
does a couple of interesting things: * Like I said in the introduction,
calling the `import_array()` function in the `%init` section now
also initialises the memory deallocation code. There is nothing else to
add here. * An exception is generated if memory allocation fails. After
a few iterations of the code construct, using `errno` and
`SWIG_fail` is the simplest I&#8217;ve come-up with. * In this example,
two inline functions are created, one using ARGOUTVIEW_ARRAY1 and the
other ARGOUTVIEWM_ARRAY1. Both function use the `alloc()` function
(see ezalloc.h and ezalloc.c).</p>
<div class="highlight-python"><pre>%module ezalloc
%{
#include &lt;errno.h&gt;
#include "ezalloc.h"

#define SWIG_FILE_WITH_INIT
%}

%include "numpy.i"

%init %{
    import_array();
%}

%apply (int** ARGOUTVIEWM_ARRAY1, int *DIM1) {(int** veco1, int* n1)}
%apply (int** ARGOUTVIEW_ARRAY1, int *DIM1) {(int** veco2, int* n2)}

%include "ezalloc.h"

%exception
{
    errno = 0;
    $action

    if (errno != 0)
    {
        switch(errno)
        {
            case ENOMEM:
                PyErr_Format(PyExc_MemoryError, "Failed malloc()");
                break;
            default:
                PyErr_Format(PyExc_Exception, "Unknown exception");
        }
        SWIG_fail;
    }
}

%rename (alloc_managed) my_alloc1;
%rename (alloc_leaking) my_alloc2;

%inline %{

void my_alloc1(int ni, int** veco1, int *n1)
{
    /* The function... */
    alloc(ni, veco1, n1);
}

void my_alloc2(int ni, int** veco2, int *n2)
{
    /* The function... */
    alloc(ni, veco2, n2);
}

%}</pre>
</div>
<p>Don&#8217;t forget that you will need the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/numpy.i">numpy.i</a>
file in the same directory for this to compile.</p>
</div>
<div class="section" id="setup-file-setup-alloc-py">
<h2>Setup file (setup_alloc.py)<a class="headerlink" href="#setup-file-setup-alloc-py" title="Permalink to this headline">¶</a></h2>
<p>This is the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/setup_alloc.py">setup_alloc.py</a>
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#! /usr/bin/env python</span>

<span class="c"># System imports</span>
<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">distutils</span>      <span class="kn">import</span> <span class="n">sysconfig</span>

<span class="c"># Third-party modules - we depend on numpy for everything</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c"># Obtain the numpy include directory.  This logic works across numpy versions.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">numpy_include</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">numpy_include</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">get_numpy_include</span><span class="p">()</span>

<span class="c"># alloc extension module</span>
<span class="n">_ezalloc</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span><span class="s">&quot;_ezalloc&quot;</span><span class="p">,</span>
                   <span class="p">[</span><span class="s">&quot;ezalloc.i&quot;</span><span class="p">,</span><span class="s">&quot;ezalloc.c&quot;</span><span class="p">],</span>
                   <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy_include</span><span class="p">],</span>

                   <span class="n">extra_compile_args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--verbose&quot;</span><span class="p">]</span>
                   <span class="p">)</span>

<span class="c"># NumyTypemapTests setup</span>
<span class="n">setup</span><span class="p">(</span>  <span class="n">name</span>        <span class="o">=</span> <span class="s">&quot;alloc functions&quot;</span><span class="p">,</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;Testing managed arrays&quot;</span><span class="p">,</span>
        <span class="n">author</span>      <span class="o">=</span> <span class="s">&quot;Egor Zindy&quot;</span><span class="p">,</span>
        <span class="n">version</span>     <span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">_ezalloc</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="compiling-the-module">
<h2>Compiling the module<a class="headerlink" href="#compiling-the-module" title="Permalink to this headline">¶</a></h2>
<p>The setup command-line is (in Windows, using mingw):</p>
<div class="highlight-python"><pre>$&gt; python setup_alloc.py build --compiler=mingw32</pre>
</div>
<p>or in UN*X, simply</p>
<div class="highlight-python"><pre>$&gt; python setup_alloc.py build</pre>
</div>
</div>
<div class="section" id="testing-the-module">
<h2>Testing the module<a class="headerlink" href="#testing-the-module" title="Permalink to this headline">¶</a></h2>
<p>If everything goes according to plan, there should be a
`_ezalloc.pyd` file available in the `build\lib.XXX` directory.
The file needs to be copied in the directory with the `ezalloc.py`
file (generated by swig).</p>
<p>A python test program is provided in the SVN repository
(<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/test_alloc.py">test_alloc.py</a>)
and reproduced below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">ezalloc</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">2048</span>

<span class="c"># this multiplied by sizeof(int) to get size in bytes...</span>
<span class="c">#assuming sizeof(int)=4 on a 32bit machine (sorry, it&#39;s late!)</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">print</span> <span class="s">&quot;ARGOUTVIEWM_ARRAY1 (managed arrays) - </span><span class="si">%d</span><span class="s"> allocations (</span><span class="si">%d</span><span class="s"> bytes each)&quot;</span> <span class="o">%</span> <span class="p">(</span>
<span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c">#allocating some memory</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ezalloc</span><span class="o">.</span><span class="n">alloc_managed</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="c">#deleting the array</span>
        <span class="k">del</span> <span class="n">a</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&quot;Step </span><span class="si">%d</span><span class="s"> failed&quot;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="k">break</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Done!</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="k">print</span> <span class="s">&quot;ARGOUTVIEW_ARRAY1 (unmanaged, leaking) - </span><span class="si">%d</span><span class="s"> allocations (</span><span class="si">%d</span><span class="s"> bytes each)&quot;</span>
<span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c">#allocating some memory</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ezalloc</span><span class="o">.</span><span class="n">alloc_leaking</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="c">#deleting the array</span>
        <span class="k">del</span> <span class="n">a</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&quot;Step </span><span class="si">%d</span><span class="s"> failed&quot;</span> <span class="o">%</span> <span class="n">i</span>
        <span class="k">break</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Done? Increase n!</span><span class="se">\n</span><span class="s">&quot;</span>
</pre></div>
</div>
<p>Then, a</p>
<div class="highlight-python"><pre>$&gt; python test_alloc.py</pre>
</div>
<p>will produce an output similar to this:</p>
<div class="highlight-python"><pre>ARGOUTVIEWM_ARRAY1 (managed arrays) - 2048 allocations (4194304 bytes each)
Done!

ARGOUTVIEW_ARRAY1 (unmanaged, leaking) - 2048 allocations (4194304 bytes each)
Step 483 failed</pre>
</div>
<p>The unmanaged array leaks memory every time the array view is deleted.
The managed one will delete the memory block seamlessly. This was tested
both in Windows XP and Linux.</p>
</div>
</div>
<div class="section" id="a-simple-argoutviewm-array2-example">
<h1>A simple ARGOUTVIEWM_ARRAY2 example<a class="headerlink" href="#a-simple-argoutviewm-array2-example" title="Permalink to this headline">¶</a></h1>
<p>The following examples shows how to return a two-dimensional array from
C which also benefits from the automatic memory deallocation.</p>
<p>A naive &#8220;crop&#8221; function is wrapped using SWIG/numpy.i and returns a
slice of the input array. When used as `array_out =
crop.crop(array_in, d1_0,d1_1, d2_0,d2_1)`, it is equivalent to
the native numpy slicing `array_out = array_in[d1_0:d1_1,
d2_0:d2_1]`.</p>
<div class="section" id="the-c-source-crop-c-and-crop-h">
<h2>The C source (crop.c and crop.h)<a class="headerlink" href="#the-c-source-crop-c-and-crop-h" title="Permalink to this headline">¶</a></h2>
<p>Here is the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/crop.h">crop.h</a>
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">void</span> <span class="n">crop</span><span class="p">(</span><span class="nb">int</span> <span class="o">*</span><span class="n">arr_in</span><span class="p">,</span> <span class="nb">int</span> <span class="n">dim1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">dim2</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d1_0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d1_1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d2_0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d2_</span>
<span class="mi">1</span><span class="p">,</span> <span class="nb">int</span> <span class="o">**</span><span class="n">arr_out</span><span class="p">,</span> <span class="nb">int</span> <span class="o">*</span><span class="n">dim1_out</span><span class="p">,</span> <span class="nb">int</span> <span class="o">*</span><span class="n">dim2_out</span><span class="p">);</span>
</pre></div>
</div>
<p>Here is the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/crop.c">crop.c</a>
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#include &lt;stdlib.h&gt;</span>
<span class="c">#include &lt;errno.h&gt;</span>

<span class="c">#include &quot;crop.h&quot;</span>

<span class="n">void</span> <span class="n">crop</span><span class="p">(</span><span class="nb">int</span> <span class="o">*</span><span class="n">arr_in</span><span class="p">,</span> <span class="nb">int</span> <span class="n">dim1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">dim2</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d1_0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d1_1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d2_0</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d2_</span>
<span class="mi">1</span><span class="p">,</span> <span class="nb">int</span> <span class="o">**</span><span class="n">arr_out</span><span class="p">,</span> <span class="nb">int</span> <span class="o">*</span><span class="n">dim1_out</span><span class="p">,</span> <span class="nb">int</span> <span class="o">*</span><span class="n">dim2_out</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nb">int</span> <span class="o">*</span><span class="n">arr</span><span class="o">=</span><span class="n">NULL</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">dim1_o</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">dim2_o</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

    <span class="o">//</span><span class="n">value</span> <span class="n">checks</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">d1_1</span> <span class="o">&lt;</span> <span class="n">d1_0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d2_1</span> <span class="o">&lt;</span> <span class="n">d2_0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">d1_0</span> <span class="o">&gt;=</span> <span class="n">dim1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d1_1</span> <span class="o">&gt;=</span> <span class="n">dim1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d1_0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d1_1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">d2_0</span> <span class="o">&gt;=</span> <span class="n">dim2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d2_1</span> <span class="o">&gt;=</span> <span class="n">dim2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d2_0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d2_1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">EPERM</span><span class="p">;</span>
        <span class="n">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">//</span><span class="n">output</span> <span class="n">sizes</span>
    <span class="n">dim1_o</span> <span class="o">=</span> <span class="n">d1_1</span><span class="o">-</span><span class="n">d1_0</span><span class="p">;</span>
    <span class="n">dim2_o</span> <span class="o">=</span> <span class="n">d2_1</span><span class="o">-</span><span class="n">d2_0</span><span class="p">;</span>

    <span class="o">//</span><span class="n">memory</span> <span class="n">allocation</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">dim1_o</span><span class="o">*</span><span class="n">dim2_o</span><span class="o">*</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">arr</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
        <span class="n">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">//</span><span class="n">copying</span> <span class="n">the</span> <span class="n">cropped</span> <span class="n">arr_in</span> <span class="n">region</span> <span class="n">to</span> <span class="n">arr</span> <span class="p">(</span><span class="n">naive</span> <span class="n">implementation</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">--- d1_0=</span><span class="si">%d</span><span class="s"> d1_1=</span><span class="si">%d</span><span class="s"> (rows)  -- d2_0=</span><span class="si">%d</span><span class="s"> d2_1=</span><span class="si">%d</span><span class="s"> (columns)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">d1_0</span><span class="p">,</span><span class="n">d</span>
<span class="mi">1</span><span class="n">_1</span><span class="p">,</span><span class="n">d2_0</span><span class="p">,</span><span class="n">d2_1</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">dim1_o</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">dim2_o</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">dim2_o</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_in</span><span class="p">[(</span><span class="n">j</span><span class="o">+</span><span class="n">d1_0</span><span class="p">)</span><span class="o">*</span><span class="n">dim2</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">d2_0</span><span class="p">)];</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> &quot;</span><span class="p">,</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="n">dim2_o</span><span class="o">+</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;---</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">end</span><span class="p">:</span>
    <span class="o">*</span><span class="n">dim1_out</span> <span class="o">=</span> <span class="n">dim1_o</span><span class="p">;</span>
    <span class="o">*</span><span class="n">dim2_out</span> <span class="o">=</span> <span class="n">dim2_o</span><span class="p">;</span>
    <span class="o">*</span><span class="n">arr_out</span> <span class="o">=</span> <span class="n">arr</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-interface-file-crop-i">
<h2>The interface file (crop.i)<a class="headerlink" href="#the-interface-file-crop-i" title="Permalink to this headline">¶</a></h2>
<p>The file (available here:
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/crop.i">crop.i</a>)
does a couple of interesting things: * The array dimensions DIM1 and
DIM2 are in the same order as array.shape on the Python side. In a row
major array definition for an image, DIM1 would the number of rows and
DIM2 the number of columns. * Using the errno library, An exception is
generated when memory allocation fails (ENOMEM) or when a problem occurs
with the indexes (EPERM).</p>
<div class="highlight-python"><pre>%module crop
%{
#include &lt;errno.h&gt;
#include "crop.h"

#define SWIG_FILE_WITH_INIT
%}

%include "numpy.i"

%init %{
    import_array();
%}

%exception crop
{
    errno = 0;
    $action

    if (errno != 0)
    {
        switch(errno)
        {
            case EPERM:
                PyErr_Format(PyExc_IndexError, "Index error");
                break;
            case ENOMEM:
                PyErr_Format(PyExc_MemoryError, "Not enough memory");
                break;
            default:
                PyErr_Format(PyExc_Exception, "Unknown exception");
        }
        SWIG_fail;
    }
}

%apply (int* IN_ARRAY2, int DIM1, int DIM2) {(int *arr_in, int dim1, int dim2)}
%apply (int** ARGOUTVIEWM_ARRAY2, int* DIM1, int* DIM2) {(int **arr_out, int *di
m1_out, int *dim2_out)}

%include "crop.h"</pre>
</div>
<p>Don&#8217;t forget that you will need the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/numpy.i">numpy.i</a>
file in the same directory for this to compile.</p>
</div>
<div class="section" id="setup-file-setup-crop-py">
<h2>Setup file (setup_crop.py)<a class="headerlink" href="#setup-file-setup-crop-py" title="Permalink to this headline">¶</a></h2>
<p>This is the
<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/setup_crop.py">setup_crop.py</a>
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#! /usr/bin/env python</span>

<span class="c"># System imports</span>
<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">distutils</span>      <span class="kn">import</span> <span class="n">sysconfig</span>

<span class="c"># Third-party modules - we depend on numpy for everything</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c"># Obtain the numpy include directory.  This logic works across numpy versions.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">numpy_include</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">numpy_include</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">get_numpy_include</span><span class="p">()</span>

<span class="c"># crop extension module</span>
<span class="n">_crop</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span><span class="s">&quot;_crop&quot;</span><span class="p">,</span>
                   <span class="p">[</span><span class="s">&quot;crop.i&quot;</span><span class="p">,</span><span class="s">&quot;crop.c&quot;</span><span class="p">],</span>
                   <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy_include</span><span class="p">],</span>

                   <span class="n">extra_compile_args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--verbose&quot;</span><span class="p">]</span>
                   <span class="p">)</span>

<span class="c"># NumyTypemapTests setup</span>
<span class="n">setup</span><span class="p">(</span>  <span class="n">name</span>        <span class="o">=</span> <span class="s">&quot;crop test&quot;</span><span class="p">,</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;A simple crop test to demonstrate the use of ARGOUTVIEWM_</span>
<span class="n">ARRAY2</span><span class="s">&quot;,</span>
        <span class="n">author</span>      <span class="o">=</span> <span class="s">&quot;Egor Zindy&quot;</span><span class="p">,</span>
        <span class="n">version</span>     <span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">_crop</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Testing the module<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>If everything goes according to plan, there should be a `_crop.pyd`
file available in the `build\lib.XXX` directory. The file needs to be
copied in the directory with the `crop.py` file (generated by swig).</p>
<p>A python test program is provided in the SVN repository
(<a class="reference external" href="http://ezwidgets.googlecode.com/svn/trunk/numpy/test_crop.py">test_crop.py</a>)
and reproduced below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">crop</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="n">a</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">([(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))])</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="c">#this array is most likely NOT contiguous</span>

<span class="k">print</span> <span class="n">a</span>
<span class="k">print</span> <span class="s">&quot;dim1=</span><span class="si">%d</span><span class="s"> dim2=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">d1_0</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">d1_1</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">d2_0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">d2_1</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d1_0</span><span class="p">,</span><span class="n">d1_1</span><span class="p">,</span> <span class="n">d2_0</span><span class="p">,</span><span class="n">d2_1</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">d1_0</span><span class="p">:</span><span class="n">d1_1</span><span class="p">,</span> <span class="n">d2_0</span><span class="p">:</span><span class="n">d2_1</span><span class="p">]</span>

<span class="k">print</span> <span class="s">&quot;returned array:&quot;</span>
<span class="k">print</span> <span class="n">c</span>

<span class="k">print</span> <span class="s">&quot;native slicing:&quot;</span>
<span class="k">print</span> <span class="n">d</span>
</pre></div>
</div>
<p>This is what the output looks like:</p>
<div class="highlight-python"><pre>$ python test_crop.py
[[    1     2     3     4     5     6     7     8     9]
 [   10    20    30    40    50    60    70    80    90]
 [  100   200   300   400   500   600   700   800   900]
 [ 1000  2000  3000  4000  5000  6000  7000  8000  9000]
 [10000 20000 30000 40000 50000 60000 70000 80000 90000]]
dim1=5 dim2=9

--- d1_0=2 d1_1=4 (rows)  -- d2_0=1 d2_1=5 (columns)
200 300 400 500
2000 3000 4000 5000
---

returned array:
[[ 200  300  400  500]
 [2000 3000 4000 5000]]
native slicing:
[[ 200  300  400  500]
 [2000 3000 4000 5000]]</pre>
</div>
<p>numpy.i takes care of making the array contiguous if needed, so the only
thing left to take care of is the array orientation.</p>
</div>
</div>
<div class="section" id="conclusion-and-comments">
<h1>Conclusion and comments<a class="headerlink" href="#conclusion-and-comments" title="Permalink to this headline">¶</a></h1>
<p>That&#8217;s all folks! Files are available on the <a class="reference external" href="http://code.google.com/p/ezwidgets/source/browse/#svn/trunk/numpy">Google code
SVN</a>.
As usual, comments welcome!</p>
<p>Regards, Egor</p>
<hr class="docutils" />
<p>CategoryCookbook</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Table of Contents</a></li>
<li><a class="reference internal" href="#introduction">Introduction</a><ul>
<li><a class="reference internal" href="#recipe-description">Recipe description</a></li>
<li><a class="reference internal" href="#where-to-get-the-files">Where to get the files</a></li>
<li><a class="reference internal" href="#how-the-code-came-about">How the code came about</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-the-new-fragments">How to use the new fragments</a><ul>
<li><a class="reference internal" href="#important-steps">Important steps</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-simple-argoutviewm-array1-example">A simple ARGOUTVIEWM_ARRAY1 example</a><ul>
<li><a class="reference internal" href="#the-c-source-ezalloc-c-and-ezalloc-h">The C source (ezalloc.c and ezalloc.h)</a></li>
<li><a class="reference internal" href="#the-interface-file-ezalloc-i">The interface file (ezalloc.i)</a></li>
<li><a class="reference internal" href="#setup-file-setup-alloc-py">Setup file (setup_alloc.py)</a></li>
<li><a class="reference internal" href="#compiling-the-module">Compiling the module</a></li>
<li><a class="reference internal" href="#testing-the-module">Testing the module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-simple-argoutviewm-array2-example">A simple ARGOUTVIEWM_ARRAY2 example</a><ul>
<li><a class="reference internal" href="#the-c-source-crop-c-and-crop-h">The C source (crop.c and crop.h)</a></li>
<li><a class="reference internal" href="#the-interface-file-crop-i">The interface file (crop.i)</a></li>
<li><a class="reference internal" href="#setup-file-setup-crop-py">Setup file (setup_crop.py)</a></li>
<li><a class="reference internal" href="#id1">Testing the module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion-and-comments">Conclusion and comments</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Recarray.html"
                        title="previous chapter">Addressing Array Columns by Name</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="SWIG_NumPy_examples.html"
                        title="next chapter">Table of Contents</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/SWIG_Memory_Deallocation.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="SWIG_NumPy_examples.html" title="Table of Contents"
             >next</a> |</li>
        <li class="right" >
          <a href="Recarray.html" title="Addressing Array Columns by Name"
             >previous</a> |</li>
        <li><a href="index.html">CookBook 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Matti Pastell.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>